name: Build

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      spigot-target:
        type: string
    outputs:
      artifact:
        description: Path to the jar artifact
        value: ${{ jobs.build.outputs.artifact }}
      artifact-dir:
        description: Path to the original artifact directory
        value: ${{ jobs.build.outputs.artifact-dir }}

jobs:
  build:
    name: Gradle build
    env:
      ARTIFACT_DIR: packages/single/build/libs
      ARTIFACT: packages/single/build/libs/MapModCompanion.jar
    outputs:
      artifact: ${{ env.ARTIFACT }}
      artifact-dir: ${{ env.ARTIFACT_DIR }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1
      - name: Determine target Spigot version
        id: target
        run: |
          TARGET=${{ inputs.spigot-target }}
          [[ -z "$TARGET" ]] && TARGET=$(tail -n1 VERSIONS.txt)
          echo "spigot-version=$TARGET" >> $GITHUB_OUTPUT
      - uses: gradle/gradle-build-action@v2
        with:
          arguments: |
            build
            -Pversion=${{ inputs.version }}
            -Pspigot_version=${{ steps.target.outputs.spigot-version }}
            -PprotocolLib_version=4.2.1
      - uses: actions/upload-artifact@v3
        with:
          name: gradle-build
          path: ${{ env.ARTIFACT }}

name: E2E test (common)

on:
  workflow_call:
    inputs:
      artifact-dir:
        required: true
        type: string
      proxy:
        required: true
        type: string
      version:
        required: true
        type: string

jobs:
  test:
    name: E2E test (${{ inputs.version }}, ${{ inputs.proxy }})
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./tests_e2e
    env:
     # Legacy builder doesn't seem to properly mount /data folder inside server container for some reason
     DOCKER_BUILDKIT: 1
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: gradle-build
          path: ${{ inputs.artifact-dir }}
      - name: Build
        run: ./run.sh ${{ inputs.proxy }} ${{ inputs.version }} build
      - name: Test
        run: ./run.sh ${{ inputs.proxy }} ${{ inputs.version }} test
